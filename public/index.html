<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendly Auto Booker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0; /* Remove body padding, apply to container */
            background-color: #f5f7fa;
            color: #333;
        }
        .app-header {
            background-color: #2c3e50;
            padding: 15px 0;
            color: #ecf0f1;
        }
        .nav-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px; /* Add padding to match container */
        }
        .nav-container h1 { /* Style header title */
            margin: 0;
            color: #ecf0f1; /* White text */
            font-size: 24px;
        }
        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            gap: 20px;
        }
        nav a {
            color: #bdc3c7; /* Lighter gray for links */
            text-decoration: none;
            font-size: 16px;
            padding: 5px 0;
            border-bottom: 2px solid transparent;
            transition: color 0.3s, border-bottom-color 0.3s;
        }
        nav a:hover,
        nav a.active {
            color: #fff; /* White on hover/active */
            border-bottom-color: #3498db; /* Blue underline */
        }

        .container {
            max-width: 800px;
            margin: 20px auto; /* Add margin top/bottom */
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        /* Hide pages by default */
        .page-content {
            display: none;
        }
        /* Show the active page */
        .page-content.active {
            display: block;
        }

        h1 {
            margin-bottom: 30px;
            color: #2c3e50;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="url"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .results {
            margin-top: 30px;
            padding: 20px;
            border-radius: 4px;
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
        }
        .results h2 {
            margin-top: 0;
            color: #2c3e50;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric {
            padding: 15px;
            border-radius: 4px;
            background-color: #e8f4fc;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2980b9;
            margin: 5px 0;
        }
        .metric-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        .logs {
            max-height: 300px;
            overflow-y: auto;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.4;
        }
        .loading, .preload-loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-left-color: #3498db;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error, .preload-error {
            background-color: #fdedee;
            color: #e74c3c;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #e74c3c;
            display: none; /* Hidden by default */
        }
        .intro-text {
            font-size: 18px;
            margin-bottom: 20px;
            color: #2c3e50;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="nav-container">
            <h1>Calendly Auto Booker</h1>
            <nav>
                <ul>
                    <li><a href="#direct-booking" id="nav-direct-booking">Direct Booking</a></li>
                    <li><a href="#calendar-navigation" id="nav-calendar-navigation" class="active">Calendar Navigation Booking</a></li>
                    <li><a href="#predictive-booking" id="nav-predictive-booking">Predictive Booking</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- Page Content Area -->
        <div id="direct-booking-page" class="page-content">
            <h2>Direct Booking</h2>
            <p>
                The workflow has two steps. First, as soon as Julian joins a call with a prospect, the program assigns a dedicated IP to the session and navigates to the customer's general Calendly page. Then, when the user provides a fully-qualified Calendly booking URL (including a specific date and time), the system performs a direct page.goto() to that URL and fills out the form using a pre-scripted form filler. This approach is simple because it avoids dealing with DOM interactions on the calendar page. However, since it relies on a full navigation step, it can take up to 30 seconds during high-latency periods and averages around 12. The system uses ISP proxies, which are hosted in data centers but offer residential-like undetectability.</p>

            <!-- Preload Section (Now visible by default after modal dismissal) -->
            <div id="preload-section">
                <div id="preload-error" class="preload-error"></div>
                <form id="preload-form">
                    <div class="form-group">
                        <label for="preload-calendly-url">What Page Will Julian Book On?</label>
                        <input type="url" id="preload-calendly-url" name="baseUrl" required
                               placeholder="e.g., https://calendly.com/username/30min">
                    </div>
                    <button type="submit" id="preload-btn">Preload Session</button>
                </form>
                <div class="preload-loading" id="preload-loading">
                    <div class="spinner"></div>
                    <p>Initializing session and preloading Calendly page...
                        A warm browser and IP are being set up behind the scenes. Est Time: 1 minute.</p>
                </div>
                <div class="logs" id="preload-logs" style="display: none; margin-top: 20px;">
                     <!-- Preload Logs will be inserted here -->
                </div>
            </div>

            <!-- Booking Section (Initially Hidden) -->
            <div id="booking-section" style="display: none;">
                <p>Step 2: Provide the specific booking details below.</p>

                <div id="error" class="error"></div>

                <form id="booking-form">
                    <div class="form-group">
                        <label for="calendly-url">Specific Calendly Booking URL:</label>
                        <input type="url" id="calendly-url" name="fullBookingUrl" required
                               placeholder="https://calendly.com/username/30min/YYYY-MM-DDTHH:mm:ss...">
                    </div>

                    <div class="form-group">
                        <label for="name">Name:</label>
                        <input type="text" id="name" name="name" required placeholder="John Doe">
                    </div>

                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" required placeholder="john@example.com">
                    </div>

                    <div class="form-group" style="display: flex; gap: 10px;">
                        <div style="flex: 0 0 80px;">
                            <label for="phone-country-code">Code</label>
                            <input type="text" id="phone-country-code" name="phoneCountryCode" required placeholder="+1" style="text-align: center;">
                        </div>
                        <div style="flex: 1;">
                            <label for="phone-number">Phone Number</label>
                            <input type="tel" id="phone-number" name="phoneNumber" required placeholder="3109122380 (no spaces/dashes)">
                        </div>
                    </div>

                    <button type="submit" id="submit-btn"> Book Appointment</button>
                </form>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Booking appointment... This may take a minute longer than expected because Render instance needs to spin up.</p>
                </div>

                <div class="results" id="results" style="display: none;">
                    <h2>Booking Results</h2>

                    <div class="metrics" id="metrics">
                        <!-- Metrics will be inserted here -->
                    </div>

                    <h3>Booking Logs:</h3>
                    <div class="logs" id="logs">
                        <!-- Logs will be inserted here -->
                    </div>
                </div>
            </div>
        </div> <!-- End of direct-booking-page -->

        <div id="calendar-navigation-page" class="page-content active">
            <h2>Calendar Navigation Booking</h2>
            <p>This workflow is two steps and has been my best-performing one. First, as soon as Julian joins a call with a prospect, the program assigns a dedicated IP to the session and navigates to the customer's general Calendly page, where it sits idly until it's time to book. Then, instead of performing a goto() directly to the booking URL, the system finds the booking slot on the calendar itself. The benefit of this approach is that all calendar-related assets are already cached, so there's virtually no loading time. The system uses ISP proxies, which are hosted in data centers but offer residential-like undetectability.</p>
            <!-- Calendar Navigation: Step 1 - Start Session (renamed from dtp-*) -->
            <div id="cn-start-section">
                <div id="cn-start-error" class="preload-error"></div>
                <form id="cn-start-form">
                    <div class="form-group">
                        <label for="cn-calendly-url">What Page Will Julian Book On?</label>
                        <input type="url" id="cn-calendly-url" name="baseUrl" required
                               placeholder="e.g., https://calendly.com/username/30min">
                    </div>
                    <button type="submit" id="cn-start-btn">Preload Session</button>
                </form>
                <div class="preload-loading" id="cn-start-loading">
                    <div class="spinner"></div>
                    <p>Initializing session and preloading Calendly page...
                        A warm browser and IP are being set up behind the scenes. Est. Time: 1 minute.</p>
                </div>
                <div class="logs" id="cn-start-logs" style="display: none; margin-top: 20px;">
                     <!-- Calendar Navigation Start Logs will be inserted here -->
                </div>
            </div>

            <!-- Calendar Navigation: Step 2 - Booking Form (renamed from dtp-*) -->
            <div id="cn-booking-section" style="display: none;">
                <p>Now, provide the specific date/time URL. The system will interact with the page like a human — navigating the calendar DOM, selecting the correct date and time, and then quickly filling out the form.</p>

               <div id="cn-booking-error" class="error"></div>

               <form id="cn-booking-form">
                   <div class="form-group">
                       <label for="cn-calendly-url-final">Specific Calendly Booking URL:</label>
                       <input type="url" id="cn-calendly-url-final" name="fullBookingUrl" required
                              placeholder="https://calendly.com/username/30min/YYYY-MM-DDTHH:mm:ss...">
                   </div>

                   <div class="form-group">
                       <label for="cn-name">Name:</label>
                       <input type="text" id="cn-name" name="name" required placeholder="John Doe">
                   </div>

                   <div class="form-group">
                       <label for="cn-email">Email:</label>
                       <input type="email" id="cn-email" name="email" required placeholder="john@example.com">
                   </div>

                   <div class="form-group" style="display: flex; gap: 10px;">
                       <div style="flex: 0 0 80px;">
                           <label for="cn-phone-country-code">Code</label>
                           <input type="text" id="cn-phone-country-code" name="phoneCountryCode" required placeholder="+1" style="text-align: center;">
                       </div>
                       <div style="flex: 1;">
                           <label for="cn-phone-number">Phone Number</label>
                           <input type="tel" id="cn-phone-number" name="phoneNumber" required placeholder="3109122380 (no spaces/dashes)">
                       </div>
                   </div>

                   <button type="submit" id="cn-submit-btn">Book Appointment (DOM Navigation)</button>
               </form>

               <div class="loading" id="cn-booking-loading">
                   <div class="spinner"></div>
                   <p>Booking appointment via DOM navigation... This may take a minute longer than expected because Render instance needs to spin up.</p>
               </div>

               <div class="results" id="cn-booking-results" style="display: none;">
                   <h2>Booking Results (DOM Navigation)</h2>

                   <div class="metrics" id="cn-booking-metrics">
                       <!-- Calendar Navigation Metrics will be inserted here -->
                   </div>

                   <h3>Booking Logs (DOM Navigation):</h3>
                   <div class="logs" id="cn-booking-logs">
                       <!-- Calendar Navigation Logs will be inserted here -->
                   </div>
               </div>
           </div>
        </div> <!-- End of calendar-navigation-page -->

        <div id="predictive-booking-page" class="page-content">
            <h2>Predictive Booking</h2>
            <p>This workflow is an idea that could reduce the booking time to almost zero. When Julian says, "Does 3 PM Thursday or 11 AM Friday sound better?" the program could immediately begin filling out both booking forms and get them cued up. Then, when the prospect says: "Thursday at 3pm works best for me," all the booking system needs to do is press submit! That's exactly what this system does — and it delivers 1-2 second bookings. However, right now, the form prefilling step takes a few minutes because I added cautious browser initialization logic since I only have a limited number of ISP proxies and was concerned about getting blacklisted with such a direct approach.</p>

            <!-- Predictive Booking: Step 1 - Collect booking information -->
            <div id="pb-start-section">
                <div id="pb-start-error" class="preload-error"></div>
                <form id="pb-start-form">
                    <div class="form-group">
                        <label for="pb-calendly-url1">First Potential Meeting Time (Exact URL):</label>
                        <input type="url" id="pb-calendly-url1" name="bookingUrl1" required
                               placeholder="e.g., https://calendly.com/username/30min/2023-06-01T14:00:00...">
                    </div>
                    
                    <div class="form-group">
                        <label for="pb-calendly-url2">Second Potential Meeting Time (Exact URL):</label>
                        <input type="url" id="pb-calendly-url2" name="bookingUrl2" required
                               placeholder="e.g., https://calendly.com/username/30min/2023-06-02T15:00:00...">
                    </div>

                    <div class="form-group">
                        <label for="pb-name">Client Name:</label>
                        <input type="text" id="pb-name" name="name" required placeholder="John Doe">
                    </div>

                    <div class="form-group">
                        <label for="pb-email">Client Email:</label>
                        <input type="email" id="pb-email" name="email" required placeholder="john@example.com">
                    </div>

                    <div class="form-group" style="display: flex; gap: 10px;">
                        <div style="flex: 0 0 80px;">
                            <label for="pb-phone-country-code">Code</label>
                            <input type="text" id="pb-phone-country-code" name="phoneCountryCode" required placeholder="+1" style="text-align: center;">
                        </div>
                        <div style="flex: 1;">
                            <label for="pb-phone-number">Phone Number</label>
                            <input type="tel" id="pb-phone-number" name="phoneNumber" required placeholder="3109122380 (no spaces/dashes)">
                        </div>
                    </div>

                    <button type="submit" id="pb-start-btn">Prepare Both Meeting Options</button>
                </form>
                <div class="preload-loading" id="pb-start-loading">
                    <div class="spinner"></div>
                    <p>Preparing both meeting options with dedicated browsers...
                        This process will take 2 minutes.</p>
                </div>
                <div class="logs" id="pb-start-logs" style="display: none; margin-top: 20px;">
                     <!-- PB Start Logs will be inserted here -->
                </div>
            </div>

            <!-- Predictive Booking: Step 2 - Julian's suggestion -->
            <div id="pb-suggestion-section" style="display: none;">
                <h3>Julian's Meeting Suggestion</h3>
                <div class="suggestion-box" style="background-color: #f0f7fb; padding: 20px; border-radius: 8px; border-left: 4px solid #3498db; margin-bottom: 20px;">
                    <p style="font-size: 18px; margin-bottom: 15px;">Julian says: "How does <span id="time1-display">Thursday at 2:00 PM</span> or <span id="time2-display">Friday at 3:30 PM</span> sound for a meeting?"</p>
                    
                    <div style="display: flex; gap: 15px;">
                        <button id="option1-btn" class="option-btn" style="flex: 1; padding: 12px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Select First Option</button>
                        <button id="option2-btn" class="option-btn" style="flex: 1; padding: 12px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Select Second Option</button>
                    </div>
                </div>
                
                <div class="loading" id="pb-booking-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Booking the selected meeting time...</p>
                </div>
                
                <div class="results" id="pb-booking-results" style="display: none;">
                    <h2>Booking Results</h2>
                    <div class="metrics" id="pb-booking-metrics">
                        <!-- PB Metrics will be inserted here -->
                    </div>
                    <h3>Booking Logs:</h3>
                    <div class="logs" id="pb-booking-logs">
                        <!-- PB Logs will be inserted here -->
                    </div>
                </div>
            </div>
        </div> <!-- End of predictive-booking-page -->
    </div> <!-- End of container -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Global variable to store the session ID
            let currentSessionId = null;

            // --- Page Navigation Elements ---
            const navDirectBooking = document.getElementById('nav-direct-booking');
            const navCalendarNavigation = document.getElementById('nav-calendar-navigation');
            const navPredictiveBooking = document.getElementById('nav-predictive-booking');
            const directBookingPage = document.getElementById('direct-booking-page');
            const calendarNavigationPage = document.getElementById('calendar-navigation-page');
            const predictiveBookingPage = document.getElementById('predictive-booking-page');
            const navLinks = [navDirectBooking, navCalendarNavigation, navPredictiveBooking];
            const pageContents = [directBookingPage, calendarNavigationPage, predictiveBookingPage];

            // --- Element References (Direct Booker Page) ---
            // Preload elements
            const preloadSection = document.getElementById('preload-section');
            const preloadForm = document.getElementById('preload-form');
            const preloadUrlInput = document.getElementById('preload-calendly-url');
            const preloadBtn = document.getElementById('preload-btn');
            const preloadLoading = document.getElementById('preload-loading');
            const preloadError = document.getElementById('preload-error');
            const preloadLogs = document.getElementById('preload-logs'); // Added for preload logs

            // Booking elements
            const bookingSection = document.getElementById('booking-section');
            const bookingForm = document.getElementById('booking-form');
            const submitBtn = document.getElementById('submit-btn');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const metrics = document.getElementById('metrics');
            const logs = document.getElementById('logs'); // Booking logs
            const error = document.getElementById('error'); // Booking error

            // --- Element References (Calendar Navigation Page) ---
            const cnStartSection = document.getElementById('cn-start-section');
            const cnStartForm = document.getElementById('cn-start-form');
            const cnUrlInput = document.getElementById('cn-calendly-url');
            const cnStartBtn = document.getElementById('cn-start-btn');
            const cnStartLoading = document.getElementById('cn-start-loading');
            const cnStartError = document.getElementById('cn-start-error');
            const cnStartLogs = document.getElementById('cn-start-logs');
            const cnBookingSection = document.getElementById('cn-booking-section');
            const cnBookingForm = document.getElementById('cn-booking-form');
            const cnSubmitBtn = document.getElementById('cn-submit-btn');
            const cnBookingLoading = document.getElementById('cn-booking-loading');
            const cnBookingResults = document.getElementById('cn-booking-results');
            const cnBookingMetrics = document.getElementById('cn-booking-metrics');
            const cnBookingLogs = document.getElementById('cn-booking-logs');
            const cnBookingError = document.getElementById('cn-booking-error');

            // --- Element References (Predictive Booking Page) ---
            const pbStartSection = document.getElementById('pb-start-section');
            const pbStartForm = document.getElementById('pb-start-form');
            const pbUrlInput = document.getElementById('pb-calendly-url');
            const pbStartBtn = document.getElementById('pb-start-btn');
            const pbStartLoading = document.getElementById('pb-start-loading');
            const pbStartError = document.getElementById('pb-start-error');
            const pbStartLogs = document.getElementById('pb-start-logs');
            const pbBookingSection = document.getElementById('pb-booking-section');
            const pbBookingForm = document.getElementById('pb-booking-form');
            const pbSubmitBtn = document.getElementById('pb-submit-btn');
            const pbBookingLoading = document.getElementById('pb-booking-loading');
            const pbBookingResults = document.getElementById('pb-booking-results');
            const pbBookingMetrics = document.getElementById('pb-booking-metrics');
            const pbBookingLogs = document.getElementById('pb-booking-logs');
            const pbBookingError = document.getElementById('pb-booking-error');

            // --- Add these new elements for the suggestion section ---
            const pbSuggestionSection = document.getElementById('pb-suggestion-section');
            const time1Display = document.getElementById('time1-display');
            const time2Display = document.getElementById('time2-display');
            const option1Btn = document.getElementById('option1-btn');
            const option2Btn = document.getElementById('option2-btn');

            // --- Page Navigation Logic ---
            function showPage(pageToShow) {
                // Hide all pages
                pageContents.forEach(page => page.classList.remove('active'));
                // Deactivate all nav links
                navLinks.forEach(link => link.classList.remove('active'));

                // Show the selected page and activate its link
                if (pageToShow === directBookingPage) {
                    directBookingPage.classList.add('active');
                    navDirectBooking.classList.add('active');
                } else if (pageToShow === calendarNavigationPage) {
                    calendarNavigationPage.classList.add('active');
                    navCalendarNavigation.classList.add('active');
                } else if (pageToShow === predictiveBookingPage) {
                    predictiveBookingPage.classList.add('active');
                    navPredictiveBooking.classList.add('active');
                }
            }

            navDirectBooking.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent hash jump
                showPage(directBookingPage);
            });

            navCalendarNavigation.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent hash jump
                showPage(calendarNavigationPage);
            });

            navPredictiveBooking.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent hash jump
                showPage(predictiveBookingPage);
            });

            // Initialize: Show the default page (Calendar Navigation)
            showPage(calendarNavigationPage);

            // --- Utility Function to Display Logs ---
            function displayLogs(logContainer, logMessages) {
                 if (logMessages && logMessages.length) {
                     logContainer.innerHTML = logMessages.map(log => `<div>${log}</div>`).join('');
                     logContainer.style.display = 'block'; // Show the log container
                 } else {
                     logContainer.innerHTML = '<div>No logs available for this step.</div>';
                     logContainer.style.display = 'block'; // Still show container, but with message
                 }
            }

            // --- Preload Form Submission Handler ---
            preloadForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                // Clear previous preload errors/logs and hide results
                preloadError.style.display = 'none';
                preloadError.textContent = '';
                preloadLogs.style.display = 'none'; // Hide logs initially
                preloadLogs.innerHTML = '';
                bookingSection.style.display = 'none'; // Ensure booking section is hidden
                results.style.display = 'none'; // Hide previous booking results if any

                // Disable button and show loading
                preloadBtn.disabled = true;
                preloadLoading.style.display = 'block';

                const baseUrl = preloadUrlInput.value.trim();

                try {
                    const response = await fetch('/api/start-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ baseUrl: baseUrl })
                    });

                    const data = await response.json();

                    // Display preload logs regardless of success/failure
                    displayLogs(preloadLogs, data.logs);

                    if (response.ok && data.success) {
                        currentSessionId = data.sessionId; // Store the session ID
                        console.log(`Session started: ${currentSessionId}`);

                        // Hide preload section, show booking section
                        preloadSection.style.display = 'none';
                        bookingSection.style.display = 'block';
                        // Clear any previous booking errors/results when showing the section
                        error.style.display = 'none';
                        results.style.display = 'none';

                    } else {
                        // Show error in the preload section
                        preloadError.textContent = data.message || 'Failed to start session.';
                        preloadError.style.display = 'block';
                        // Ensure booking section remains hidden on preload failure
                        bookingSection.style.display = 'none';
                    }

                } catch (err) {
                    console.error('Preload Error:', err);
                    preloadError.textContent = 'Failed to connect to the server for preloading. Please try again.';
                    preloadError.style.display = 'block';
                     displayLogs(preloadLogs, [`CLIENT-SIDE ERROR: ${err.message || err}`]); // Show client error in logs
                     bookingSection.style.display = 'none'; // Ensure booking section remains hidden
                } finally {
                    // Hide loading and re-enable button
                    preloadLoading.style.display = 'none';
                    preloadBtn.disabled = false;
                }
            });


            // --- Booking Form Submission Handler ---
            bookingForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                if (!currentSessionId) {
                     error.textContent = 'Error: No active session found. Please reload and start a session first.';
                     error.style.display = 'block';
                     return;
                }

                // Clear previous booking results/errors
                error.style.display = 'none';
                error.textContent = '';
                results.style.display = 'none';
                metrics.innerHTML = '';
                logs.innerHTML = ''; // Clear booking logs

                // Disable submit button and show loading
                submitBtn.disabled = true;
                loading.style.display = 'block';

                // Get form data
                let countryCode = document.getElementById('phone-country-code').value.trim(); // Use let to allow modification
                const number = document.getElementById('phone-number').value.trim().replace(/\s+/g, ''); // Remove internal spaces too

                // Ensure country code starts with +
                if (countryCode && !countryCode.startsWith('+')) {
                    countryCode = '+' + countryCode;
                    console.log('Added "+" to country code.'); // Optional: log this change
                }

                const combinedPhone = `${countryCode} ${number}`; // Format: +1 1234567890

                const formData = {
                    sessionId: currentSessionId,
                    fullBookingUrl: document.getElementById('calendly-url').value.trim(),
                    name: document.getElementById('name').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: combinedPhone // Use the combined phone string
                };

                // Validate combinedPhone format (basic check) - Optional but recommended client-side
                const phoneRegex = /^\+\d{1,4}\s\d{7,}$/; // Example: + followed by 1-4 digits, space, then 7+ digits
                if (!phoneRegex.test(combinedPhone)) {
                    error.textContent = 'Invalid phone format. Please use format like "+1 1234567890". Check country code and number.';
                    error.style.display = 'block';
                    loading.style.display = 'none';
                    submitBtn.disabled = false;
                    return; // Stop submission
                }

                try {
                    // Make API request to the new endpoint
                    const response = await fetch('/api/book-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();

                     // Display booking logs (returned from book-session)
                     displayLogs(logs, data.logs); // Use the booking logs container

                    if (response.ok && data.success) {
                        // Display metrics (assuming structure is similar)
                        metrics.innerHTML = `
                            <div class="metric">
                                <div class="metric-label">Total Time</div>
                                <div class="metric-value">${data.duration}s</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Browser Setup</div>
                                <div class="metric-value">${(data.metrics?.browserTime || 'N/A')}s</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Navigation</div>
                                <div class="metric-value">${(data.metrics?.navigationTime || 'N/A')}s</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Form Filling</div>
                                <div class="metric-value">${(data.metrics?.formTime || 'N/A')}s</div>
                            </div>
                        `;
                         // Note: Adjusted metric access based on potential structure returned by bookSession

                        // Show results section
                        results.style.display = 'block';
                    } else {
                        // Show error in the booking section
                        error.textContent = data.message || 'An error occurred while booking the appointment.';
                        error.style.display = 'block';
                        // Logs are already displayed above, but ensure results container is visible if logs exist
                        if (data.logs && data.logs.length) {
                            results.style.display = 'block'; // Keep results visible to show logs
                        }
                    }
                } catch (err) {
                    console.error('Booking Error:', err);
                    error.textContent = 'Failed to connect to the server for booking. Please try again.';
                    error.style.display = 'block';
                     displayLogs(logs, [`CLIENT-SIDE ERROR: ${err.message || err}`]); // Show client error in booking logs
                     results.style.display = 'block'; // Keep results visible to show logs
                } finally {
                    // Hide loading and re-enable submit button
                    loading.style.display = 'none';
                    submitBtn.disabled = false;
                }
            });

            // --- Calendar Navigation: Start Session Form Submission Handler ---
            cnStartForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                // Clear previous start errors/logs
                cnStartError.style.display = 'none';
                cnStartError.textContent = '';
                cnStartLogs.style.display = 'none';
                cnStartLogs.innerHTML = '';
                cnBookingSection.style.display = 'none'; // Ensure booking section is hidden initially
                cnBookingResults.style.display = 'none'; // Hide results initially

                // Disable button and show loading
                cnStartBtn.disabled = true;
                cnStartLoading.style.display = 'block';

                const baseUrl = cnUrlInput.value.trim();
                currentSessionId = null; // Reset session ID before starting a new one

                try {
                    // Use the same /api/start-session endpoint
                    const response = await fetch('/api/start-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ baseUrl: baseUrl })
                    });

                    const data = await response.json();

                    // Display start logs
                    displayLogs(cnStartLogs, data.logs);

                    if (response.ok && data.success) {
                        currentSessionId = data.sessionId; // Store the session ID
                        console.log(`Calendar Navigation Session started: ${currentSessionId}`);

                        // Hide start section, show booking section
                        cnStartSection.style.display = 'none';
                        cnBookingSection.style.display = 'block';

                        // Clear any previous booking errors/results when showing the section
                        cnBookingError.style.display = 'none';
                        cnBookingResults.style.display = 'none';

                    } else {
                        // Show error in the start section
                        cnStartError.textContent = data.message || 'Failed to start Calendar Navigation session.';
                        cnStartError.style.display = 'block';
                    }

                } catch (err) {
                    console.error('Calendar Navigation Start Error:', err);
                    cnStartError.textContent = 'Failed to connect to the server for Calendar Navigation session start. Please try again.';
                    cnStartError.style.display = 'block';
                    displayLogs(cnStartLogs, [`CLIENT-SIDE ERROR: ${err.message || err}`]);
                } finally {
                    // Hide loading and re-enable button
                    cnStartLoading.style.display = 'none';
                    cnStartBtn.disabled = false;
                }
            });

            // --- Calendar Navigation: Booking Form Submission Handler ---
            cnBookingForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                if (!currentSessionId) {
                     cnBookingError.textContent = 'Error: No active Calendar Navigation session found. Please start a session first on this tab.';
                     cnBookingError.style.display = 'block';
                     return;
                }

                // Clear previous booking results/errors
                cnBookingError.style.display = 'none';
                cnBookingError.textContent = '';
                cnBookingResults.style.display = 'none';
                cnBookingMetrics.innerHTML = '';
                cnBookingLogs.innerHTML = ''; // Clear booking logs

                // Disable submit button and show loading
                cnSubmitBtn.disabled = true;
                cnBookingLoading.style.display = 'block';

                // Get form data
                let countryCode = document.getElementById('cn-phone-country-code').value.trim();
                const number = document.getElementById('cn-phone-number').value.trim().replace(/\s+/g, '');

                // Ensure country code starts with +
                if (countryCode && !countryCode.startsWith('+')) {
                    countryCode = '+' + countryCode;
                }

                const combinedPhone = `${countryCode} ${number}`;

                const formData = {
                    sessionId: currentSessionId,
                    fullBookingUrl: document.getElementById('cn-calendly-url-final').value.trim(),
                    name: document.getElementById('cn-name').value.trim(),
                    email: document.getElementById('cn-email').value.trim(),
                    phone: combinedPhone // Use the combined phone string
                };

                // Validate combinedPhone format
                const phoneRegex = /^\+\d{1,4}\s\d{7,}$/;
                if (!phoneRegex.test(combinedPhone)) {
                    cnBookingError.textContent = 'Invalid phone format. Please use format like "+1 1234567890".';
                    cnBookingError.style.display = 'block';
                    cnBookingLoading.style.display = 'none';
                    cnSubmitBtn.disabled = false;
                    return; // Stop submission
                }

                try {
                    // Make API request to the DOM booking endpoint (same as before)
                    const response = await fetch('/api/book-session-dom', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();

                     // Display booking logs
                     displayLogs(cnBookingLogs, data.logs);

                    if (response.ok && data.success) {
                        // Display metrics
                        cnBookingMetrics.innerHTML = `
                            <div class="metric">
                                <div class="metric-label">Total Time</div>
                                <div class="metric-value">${data.duration}s</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">DOM Nav Time</div>
                                <div class="metric-value">${(data.domNavigationTime || data.navigationTime || 'N/A')}s</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Form Filling Time</div>
                                <div class="metric-value">${(data.formDuration || data.bookingServiceDuration || 'N/A')}s</div>
                            </div>
                        `;

                        // Show results section
                        cnBookingResults.style.display = 'block';
                    } else {
                        // Show error
                        cnBookingError.textContent = data.message || 'An error occurred while booking the appointment (DOM Navigation).';
                        cnBookingError.style.display = 'block';
                        // Ensure results container is visible if logs exist
                        if (data.logs && data.logs.length) {
                            cnBookingResults.style.display = 'block';
                        }
                    }
                } catch (err) {
                    console.error('Calendar Navigation Booking Error:', err);
                    cnBookingError.textContent = 'Failed to connect to the server for Calendar Navigation booking. Please try again.';
                    cnBookingError.style.display = 'block';
                    displayLogs(cnBookingLogs, [`CLIENT-SIDE ERROR: ${err.message || err}`]);
                    cnBookingResults.style.display = 'block'; // Keep results visible to show logs
                } finally {
                    // Hide loading and re-enable submit button
                    cnBookingLoading.style.display = 'none';
                    cnSubmitBtn.disabled = false;
                }
            });

            // --- Predictive Booking: Start Form Handler ---
            pbStartForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Clear previous errors/logs
                pbStartError.style.display = 'none';
                pbStartError.textContent = '';
                pbStartLogs.style.display = 'none';
                pbStartLogs.innerHTML = '';
                pbSuggestionSection.style.display = 'none';
                
                // Disable button and show loading
                pbStartBtn.disabled = true;
                pbStartLoading.style.display = 'block';
                
                // Get form data
                const url1 = document.getElementById('pb-calendly-url1').value.trim();
                const url2 = document.getElementById('pb-calendly-url2').value.trim();
                let countryCode = document.getElementById('pb-phone-country-code').value.trim();
                const number = document.getElementById('pb-phone-number').value.trim().replace(/\s+/g, '');
                
                // Ensure country code starts with +
                if (countryCode && !countryCode.startsWith('+')) {
                    countryCode = '+' + countryCode;
                }
                
                const combinedPhone = `${countryCode} ${number}`;
                
                // Validate phone format
                const phoneRegex = /^\+\d{1,4}\s\d{7,}$/;
                if (!phoneRegex.test(combinedPhone)) {
                    pbStartError.textContent = 'Invalid phone format. Please use format like "+1 1234567890".';
                    pbStartError.style.display = 'block';
                    pbStartLoading.style.display = 'none';
                    pbStartBtn.disabled = false;
                    return; // Stop submission
                }
                
                // Prepare data for API call
                const formData = {
                    bookingUrl1: url1,
                    bookingUrl2: url2,
                    name: document.getElementById('pb-name').value.trim(),
                    email: document.getElementById('pb-email').value.trim(),
                    phone: combinedPhone
                };
                
                try {
                    // Call new API endpoint for predictive booking
                    const response = await fetch('/api/start-predictive-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const data = await response.json();
                    
                    // Display logs
                    displayLogs(pbStartLogs, data.logs);
                    
                    if (response.ok && data.success) {
                        // Store session IDs for later use
                        currentPredictiveSession = {
                            sessionId1: data.sessionId1,
                            sessionId2: data.sessionId2,
                            bookingUrl1: url1,
                            bookingUrl2: url2,
                            clientInfo: {
                                name: formData.name,
                                email: formData.email,
                                phone: formData.phone
                            }
                        };
                        
                        // Parse and display the two time options in a human-readable format
                        try {
                            // Extract datetime from the URL and format it nicely for display
                            // This is a basic implementation - you may need to adjust based on your actual URL format
                            const extractAndFormatTime = (url) => {
                                // Try to extract the datetime parameter from the URL
                                const dateMatch = url.match(/\/(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})/);
                                if (dateMatch && dateMatch[1]) {
                                    const dateObj = new Date(dateMatch[1]);
                                    // Format: "Thursday, June 1 at 2:00 PM"
                                    return dateObj.toLocaleDateString('en-US', {
                                        weekday: 'long',
                                        month: 'long',
                                        day: 'numeric'
                                    }) + ' at ' + 
                                    dateObj.toLocaleTimeString('en-US', {
                                        hour: 'numeric',
                                        minute: '2-digit',
                                        hour12: true
                                    });
                                }
                                return "the specified time"; // Fallback
                            };
                            
                            time1Display.textContent = extractAndFormatTime(url1);
                            time2Display.textContent = extractAndFormatTime(url2);
                        } catch (parseError) {
                            console.error('Error parsing datetime:', parseError);
                            time1Display.textContent = "the first option";
                            time2Display.textContent = "the second option";
                        }
                        
                        // Hide start section, show suggestion section
                        pbStartSection.style.display = 'none';
                        pbSuggestionSection.style.display = 'block';
                        
                    } else {
                        // Show error
                        pbStartError.textContent = data.message || 'Failed to start predictive booking session.';
                        pbStartError.style.display = 'block';
                    }
                } catch (err) {
                    console.error('Predictive Booking Error:', err);
                    pbStartError.textContent = 'Failed to connect to the server. Please try again.';
                    pbStartError.style.display = 'block';
                    displayLogs(pbStartLogs, [`CLIENT-SIDE ERROR: ${err.message || err}`]);
                } finally {
                    // Hide loading and re-enable button
                    pbStartLoading.style.display = 'none';
                    pbStartBtn.disabled = false;
                }
            });

            // Store predictive session data
            let currentPredictiveSession = null;

            // --- Predictive Booking: Option Selection Handlers ---
            option1Btn.addEventListener('click', function() {
                if (currentPredictiveSession) {
                    // Book the first option
                    bookSelectedOption(1);
                }
            });

            option2Btn.addEventListener('click', function() {
                if (currentPredictiveSession) {
                    // Book the second option
                    bookSelectedOption(2);
                }
            });

            async function bookSelectedOption(optionNumber) {
                if (!currentPredictiveSession) {
                    return;
                }
                
                // Disable both option buttons
                option1Btn.disabled = true;
                option2Btn.disabled = true;
                
                // Show loading
                pbBookingLoading.style.display = 'block';
                pbBookingResults.style.display = 'none';
                
                // Determine which session ID to use
                const sessionId = optionNumber === 1 ? 
                    currentPredictiveSession.sessionId1 : 
                    currentPredictiveSession.sessionId2;
                
                const bookingUrl = optionNumber === 1 ? 
                    currentPredictiveSession.bookingUrl1 : 
                    currentPredictiveSession.bookingUrl2;
                
                try {
                    // Make actual API call to complete the booking
                    const response = await fetch('/api/complete-predictive-booking', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sessionId: sessionId,
                            selectedOption: optionNumber
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Display actual metrics from response
                        pbBookingMetrics.innerHTML = `
                            <div class="metric">
                                <div class="metric-label">Total Time</div>
                                <div class="metric-value">${result.duration?.toFixed(1) || '0.0'}s</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Selection</div>
                                <div class="metric-value">Option ${optionNumber}</div>
                            </div>
                        `;
                        
                        // Display actual logs from response
                        let logsHtml = '';
                        if (result.logs && result.logs.length > 0) {
                            logsHtml = result.logs.map(log => `<div>${log}</div>`).join('');
                        } else {
                            logsHtml = `
                                <div>Using pre-warmed session ${sessionId}...</div>
                                <div>Selected Option ${optionNumber}: ${bookingUrl}</div>
                                <div>Submitting form with client info...</div>
                                <div>Name: ${currentPredictiveSession.clientInfo.name}</div>
                                <div>Email: ${currentPredictiveSession.clientInfo.email}</div>
                                <div>Phone: ${currentPredictiveSession.clientInfo.phone}</div>
                                <div>Successfully booked appointment!</div>
                            `;
                        }
                        pbBookingLogs.innerHTML = logsHtml;
                    } else {
                        // Display error message
                        pbBookingMetrics.innerHTML = `
                            <div class="metric">
                                <div class="metric-label">Status</div>
                                <div class="metric-value error">Failed</div>
                            </div>
                        `;
                        
                        // Display error logs
                        let errorLogsHtml = '';
                        if (result.logs && result.logs.length > 0) {
                            errorLogsHtml = result.logs.map(log => `<div>${log}</div>`).join('');
                        } else {
                            errorLogsHtml = `
                                <div>Error: ${result.message || 'Unknown error occurred'}</div>
                            `;
                        }
                        pbBookingLogs.innerHTML = errorLogsHtml;
                    }
                } catch (error) {
                    // Handle fetch errors
                    console.error('Error completing predictive booking:', error);
                    pbBookingMetrics.innerHTML = `
                        <div class="metric">
                            <div class="metric-label">Status</div>
                            <div class="metric-value error">Error</div>
                        </div>
                    `;
                    pbBookingLogs.innerHTML = `<div>Error: Failed to complete booking. ${error.message}</div>`;
                } finally {
                    // Show results
                    pbBookingLoading.style.display = 'none';
                    pbBookingResults.style.display = 'block';
                    
                    // Re-enable buttons
                    option1Btn.disabled = false;
                    option2Btn.disabled = false;
                }
            }
        });
    </script>
</body>
</html>